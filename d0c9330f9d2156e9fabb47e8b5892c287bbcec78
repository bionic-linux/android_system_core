{
  "comments": [
    {
      "key": {
        "uuid": "63915019_4e76fbbb",
        "filename": "adb/daemon/services.cpp",
        "patchSetId": 1
      },
      "lineNbr": 71,
      "author": {
        "id": 1079148
      },
      "writtenOn": "2018-08-02T00:43:45Z",
      "side": 1,
      "message": "Tom: is this safe? I\u0027m vaguely worried about something along the lines of the following:\n\n   property gets set, but not handled immediately\n   adbd exits\n   init restarts adbd\n   init notices that the property changed, and then restarts it again?\n\nIt seems that SetProperty is definitely not synchronous (or else this wouldn\u0027t be a problem in the first place, since init would kill us before we get a chance to close the fd).\n\nMaybe this race is too unlikely to matter? (or even if it does happen, the consequence is just that your adbd startup takes an extra few hundred ms?)",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 71,
        "endChar": 12
      },
      "revId": "d0c9330f9d2156e9fabb47e8b5892c287bbcec78",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2dc41279_f12f250e",
        "filename": "adb/daemon/services.cpp",
        "patchSetId": 1
      },
      "lineNbr": 71,
      "author": {
        "id": 1066743
      },
      "writtenOn": "2018-08-02T01:09:52Z",
      "side": 1,
      "message": "https://android.googlesource.com/platform/bionic/+/master/libc/bionic/system_property_set.cpp#253\n\nseems like it\u0027s synchronous now. worst case scenario, you can read it back to make absolutely sure it works.",
      "parentUuid": "63915019_4e76fbbb",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 71,
        "endChar": 12
      },
      "revId": "d0c9330f9d2156e9fabb47e8b5892c287bbcec78",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fb0ecbc0_02cb2160",
        "filename": "adb/daemon/services.cpp",
        "patchSetId": 1
      },
      "lineNbr": 71,
      "author": {
        "id": 1079148
      },
      "writtenOn": "2018-08-02T01:34:56Z",
      "side": 1,
      "message": "Maybe we\u0027re racing ahead and getting a SIGTERM on a different thread? That still seems unlikely to me, since we\u0027d need to close this fd, and then have the transport thread notice and send a packet to the USB dispatch thread quickly enough.",
      "parentUuid": "2dc41279_f12f250e",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 71,
        "endChar": 12
      },
      "revId": "d0c9330f9d2156e9fabb47e8b5892c287bbcec78",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ffdd81cb_9af1a4fa",
        "filename": "adb/daemon/services.cpp",
        "patchSetId": 1
      },
      "lineNbr": 71,
      "author": {
        "id": 1066743
      },
      "writtenOn": "2018-08-02T02:52:17Z",
      "side": 1,
      "message": "oh nevermind, i just realized that most Android devices have an init stanza where it restarts adbd when this one property changes. then IIRC you\u0027re right and the actions taken upon that property having changed are queued and dealt with after this returns.\n\ngiven that this eventually bubbles up a single-threaded handler, would it be better to use the pause() trick that reboot_service() used to do only for the services that change properties that init will then recognize as signals to restart adb?",
      "parentUuid": "fb0ecbc0_02cb2160",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 71,
        "endChar": 12
      },
      "revId": "d0c9330f9d2156e9fabb47e8b5892c287bbcec78",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "df8156ae_5ae2ed2a",
        "filename": "adb/daemon/services.cpp",
        "patchSetId": 1
      },
      "lineNbr": 71,
      "author": {
        "id": 1079148
      },
      "writtenOn": "2018-08-02T03:27:02Z",
      "side": 1,
      "message": "The problem with that is that we\u0027re not guaranteed to actually be restarted by init when we set this property. (i.e. if we happen to be setting it to the same value.) If init doesn\u0027t restart us, then we leak a thread and fd, and the client waits forever.\n\nWe can do something like fetch, compare, set, but that seems inherently racy in a worse way than this.",
      "parentUuid": "ffdd81cb_9af1a4fa",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 71,
        "endChar": 12
      },
      "revId": "d0c9330f9d2156e9fabb47e8b5892c287bbcec78",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "04fda4cd_2a6ec165",
        "filename": "adb/daemon/services.cpp",
        "patchSetId": 1
      },
      "lineNbr": 71,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-08-02T15:58:46Z",
      "side": 1,
      "message": "We probably should just remove the init trigger then?  I only see \"on property:service.adb.root\u003d1\" or \"restart adbd\" in the recovery init.rc.  The rest of the start/stop of adbd that I see is when changing USB configuration away from adb, not due to root or not.\n\nIf you remove that, then there\u0027s no race given that property set is synchronous.\n\nThough there is one problem that you\u0027ll need to contend with, that init rate limits restarting services to only restart services 5 seconds after they\u0027ve last started.  So something like `adb root; adb unroot; adb shell` will have init delay 5 seconds before starting adbd again after the adb unroot.  That may be a limitation we\u0027re okay with?",
      "parentUuid": "df8156ae_5ae2ed2a",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 71,
        "endChar": 12
      },
      "revId": "d0c9330f9d2156e9fabb47e8b5892c287bbcec78",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "102ad5c4_988fae84",
        "filename": "adb/daemon/services.cpp",
        "patchSetId": 1
      },
      "lineNbr": 71,
      "author": {
        "id": 1079148
      },
      "writtenOn": "2018-08-02T20:36:04Z",
      "side": 1,
      "message": "Ah, I had forgotten about the special cased logic in sockets.cpp that exits adbd if we get one of these services. I think the existing code is probably okay? Scaled the patch down to just fixing reboot",
      "parentUuid": "04fda4cd_2a6ec165",
      "range": {
        "startLine": 69,
        "startChar": 0,
        "endLine": 71,
        "endChar": 12
      },
      "revId": "d0c9330f9d2156e9fabb47e8b5892c287bbcec78",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    }
  ]
}