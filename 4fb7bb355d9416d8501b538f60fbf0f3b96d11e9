{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "f005bbd7_fc6870b7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 10
      },
      "lineNbr": 0,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2023-12-19T20:29:19Z",
      "side": 1,
      "message": "One question below. Looks good",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "adffafd2_5b1ffe9c",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2023-12-19T20:29:19Z",
      "side": 1,
      "message": "don\u0027t we need cached_ops_.size() \u003e\u003d batch_size_ check as well  ?",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3b5cd837_76dee951",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-12-19T22:24:35Z",
      "side": 1,
      "message": "some ops do not have data associated(ZERO and COPY), and the amount of memory used by these ops is tiny(14 bytes each). Therefore I intentionally allowed more aggressive caching for these ops.",
      "parentUuid": "adffafd2_5b1ffe9c",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eb386702_799c4e15",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2023-12-19T22:31:06Z",
      "side": 1,
      "message": "Fair enough; however, if we have a mix of zero/copy and replace ops, cached_ops_ can still overflow.\n\nI see that you have those checks in EmitCopy() and EmitZeroBlocks(). What prevents cached_ops_ not overflowing ?",
      "parentUuid": "3b5cd837_76dee951",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a7436930_d2aa740b",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-12-19T22:52:06Z",
      "side": 1,
      "message": "Added a NeedsFlush() function to maintain a consistent criteria on when is flushing needed. We flush if amount of REPLACE/XOR ops exceeds batch_size_, or number of non-data ops exceeds block size.",
      "parentUuid": "eb386702_799c4e15",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bbc86c73_35c43684",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2023-12-20T00:13:44Z",
      "side": 1,
      "message": "\u003e number of non-data ops exceeds block size.\n\nWhy can\u0027t it be just batch size instead of comparing it with header_.block_size ? As you mention in the comment, with 4096 ops, it takes just about 56k. We should be able to cache much bigger chunks - since we are sure to flush during EmitLabel(), all copy and zero ops between two EmitLabel() calls should just zip through.",
      "parentUuid": "a7436930_d2aa740b",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "70215c81_e74eae32",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-12-20T00:21:09Z",
      "side": 1,
      "message": "We can\u0027t just use `batch_size_` because data ops and non-data ops should follow different caching restrictions. 200 data ops takes up to 4K * 200 \u003d 800K memory, vs. 200 non-data ops take only ~2.8K memory.\n\nYes we flush after every InstallOp, but a single SOURCE_COPY op can convert to a mixture of REPLACE and COPY COW ops(determined by merge sequence). So in between two EmitLabel() calls there can be a mixtures of different ops going through. E.g. 100 REPLACE ops + 300 COPY ops. To best utilize memory, it\u0027s preferable to allow a bigger caching size for non-data ops. Here the choice of `header_.block_size` is somewhat arbitrary, it can be something like `if (cached_ops_.size() \u003e batch_size_ * 8 || cached_data_.size() \u003e batch_size)`",
      "parentUuid": "bbc86c73_35c43684",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2e275afc_f695acc6",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2023-12-20T00:27:49Z",
      "side": 1,
      "message": "Right - Moving this to a constant `batch_size_ * 8` and then the `if` check is what I was suggesting.. \n\nIt\u0027s ok.. we can do that later to see if it really helps..",
      "parentUuid": "70215c81_e74eae32",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a3131787_acf30a35",
        "filename": "fs_mgr/libsnapshot/libsnapshot_cow/writer_v3.cpp",
        "patchSetId": 10
      },
      "lineNbr": 324,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2023-12-20T00:33:16Z",
      "side": 1,
      "message": "DONE, replaced with batch_size_ * 16",
      "parentUuid": "2e275afc_f695acc6",
      "revId": "4fb7bb355d9416d8501b538f60fbf0f3b96d11e9",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}