{
  "comments": [
    {
      "key": {
        "uuid": "81160460_511e3d1a",
        "filename": "init/Android.mk",
        "patchSetId": 7
      },
      "lineNbr": 58,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-08-10T13:56:42Z",
      "side": 1,
      "message": "Now this specifies whether ramdisk should be included in boot.img or system.img.\n\nAnd system.img should always be mounted as \"/\", not matter ramdisk or no-ramdisk.\ne.g., inside the system.img.\n  system/\n      - bin/\n      - etc/\n      - lib/\n      ...",
      "range": {
        "startLine": 58,
        "startChar": 8,
        "endLine": 58,
        "endChar": 37
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "277baece_8431b859",
        "filename": "init/Android.mk",
        "patchSetId": 7
      },
      "lineNbr": 58,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-08-10T16:05:45Z",
      "side": 1,
      "message": "Yes, that\u0027s the plan; BOARD_BUILD_SYSTEM_ROOT_IMAGE will now mean \"build system such that it can be the rootfs\" (include verity keys/add verity command line to the kernel command line, etc), but system.img will always include the TARGET_ROOT_OUT and will always end up as /.\n\nDoes that sound good to you?",
      "parentUuid": "81160460_511e3d1a",
      "range": {
        "startLine": 58,
        "startChar": 8,
        "endLine": 58,
        "endChar": 37
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "e74cd119_52afc3c8",
        "filename": "init/Android.mk",
        "patchSetId": 7
      },
      "lineNbr": 58,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-08-10T17:16:51Z",
      "side": 1,
      "message": "SGTM.\n\nMy understanding is that you\u0027re trying to move something needed for first-stage-ramdisk from TARGET_ROOT_OUT to TARGET_RAMDISK_OUT. And keep those not needed for first-stage in TARGET_ROOT_OUT, e.g., init.*.rc, and mount points (/vendor, /metadata, /data, etc)",
      "parentUuid": "277baece_8431b859",
      "range": {
        "startLine": 58,
        "startChar": 8,
        "endLine": 58,
        "endChar": 37
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "17a7b6c5_56add178",
        "filename": "init/Android.mk",
        "patchSetId": 7
      },
      "lineNbr": 58,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-08-10T17:59:27Z",
      "side": 1,
      "message": "Yes and importantly, always include TARGET_ROOT_OUT in system.img.",
      "parentUuid": "e74cd119_52afc3c8",
      "range": {
        "startLine": 58,
        "startChar": 8,
        "endLine": 58,
        "endChar": 37
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "33130c95_10ee2519",
        "filename": "init/Android.mk",
        "patchSetId": 7
      },
      "lineNbr": 62,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-08-10T13:56:42Z",
      "side": 1,
      "message": "The ramdisk is still included in boot.img, right?\n\nWhether to put the ramdisk.img in a dedicated /ramdisk partition should be discussed separately. (for compliance test, to make sure this is a generic ramdisk).",
      "range": {
        "startLine": 62,
        "startChar": 23,
        "endLine": 62,
        "endChar": 41
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7398dabb_7389af3a",
        "filename": "init/Android.mk",
        "patchSetId": 7
      },
      "lineNbr": 62,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-08-10T16:05:45Z",
      "side": 1,
      "message": "Yes, still in boot.img.  Though there\u0027s nothing making that a firm requirement.",
      "parentUuid": "33130c95_10ee2519",
      "range": {
        "startLine": 62,
        "startChar": 23,
        "endLine": 62,
        "endChar": 41
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "9fc6dc8d_2388e3c6",
        "filename": "init/first_stage_mount.cpp",
        "patchSetId": 7
      },
      "lineNbr": 366,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-08-10T13:56:42Z",
      "side": 1,
      "message": "\"Technically\", this should be \"/\" if there is no SwitchRoot(\"/system\") below.\nBecause system.img now contains /system folder.\n\nAnyway, using \"/system\" as an indicator to SwitchRoot(\"/system\") LGTM.",
      "range": {
        "startLine": 366,
        "startChar": 75,
        "endLine": 366,
        "endChar": 82
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "3ce239e9_6d8480f4",
        "filename": "init/first_stage_mount.cpp",
        "patchSetId": 7
      },
      "lineNbr": 366,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-08-10T16:05:45Z",
      "side": 1,
      "message": "\u003e \"Technically\", this should be \"/\" if there is no SwitchRoot(\"/system\") below.\n\nFor system-as-root?  I figure that for system-as-root devices, this code will just not execute since there is no need to specify / or /system in the fstab.  That\u0027s my intention here.\n\nFor non system-as-root, I did it this way, since it\u0027ll allow seamless upgrades.  Fstabs for devices with a ramdisk will continue to mount system.img as \u0027/system\u0027 and this code will then switch the /system mount in the ramdisk to /.  \n\nThe one strange point if we do this however, is that when the fstab for these devices is read, it\u0027ll show a mount point at /system that is currently mounted at /.  Do you think that would present any problems or are we okay there?  It\u0027s technically accurate; we did mount system.img as /system; it\u0027s just that we then also moved that mount to /.",
      "parentUuid": "9fc6dc8d_2388e3c6",
      "range": {
        "startLine": 366,
        "startChar": 75,
        "endLine": 366,
        "endChar": 82
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6ecfd5b6_83abaa01",
        "filename": "init/first_stage_mount.cpp",
        "patchSetId": 7
      },
      "lineNbr": 366,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-08-10T17:16:51Z",
      "side": 1,
      "message": "Correct, for system-as-root, system will be mounted by kernel so no need to specify it in fstab-dt. But we still need to specify \"/\" in the fstab file, for update_verity_stage and recovery to work.\n\nhttps://android.googlesource.com/device/google/wahoo/+/master/fstab.hardware#4\n\nupdate_verity_state:\nhttps://android.googlesource.com/platform/system/core/+/master/fs_mgr/fs_mgr.cpp#1395\n\nrecovery:\nhttps://android.googlesource.com/platform/bootable/recovery/+/master/recovery.cpp#844\n\n\"/\" mount points will be skipped by fs_mgr anyway.\nhttps://android.googlesource.com/platform/system/core/+/master/fs_mgr/fs_mgr.cpp#854\n\n\n\nI meant for non-system-as-root, if the author of fstab look into the content of system.img, they might mount it under \"/\". Because they might thought mounting under /system will create a strange dir layout, like /system/system/etc/, /system/system/bin, etc. \n\n\u003e it\u0027ll show a mount point at /system that is currently mounted at /.  Do you think that would present any problems or are we okay there? \n\nI\u0027m not sure currently, need more time to think about it.\nBut perhaps the check in recovery will break? because there is no \"/\" in non-system-as-root fstab file.\n   if (ensure_path_mounted_at(\"/\", \"/mnt/system\") !\u003d -1) {\n   }",
      "parentUuid": "3ce239e9_6d8480f4",
      "range": {
        "startLine": 366,
        "startChar": 75,
        "endLine": 366,
        "endChar": 82
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bade4fd9_ffc6e271",
        "filename": "init/first_stage_mount.cpp",
        "patchSetId": 7
      },
      "lineNbr": 366,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-08-10T17:59:27Z",
      "side": 1,
      "message": "I think all of those cases work with this strategy.  ro.build.system_root_image will still be set the same as it is now (devices that actually use system.img as rootfs have it set, others don\u0027t).  So all of these conditionals will find /system in the fstab when it\u0027s not set and work correctly.\n\nActually seems a bit mandatory that we continue this separation given the second link, since vroot vs system will always be a difference regardless of what mount point we use.\n\nThe last link is the only that may need a change.  We should probably skip /system as well.",
      "parentUuid": "6ecfd5b6_83abaa01",
      "range": {
        "startLine": 366,
        "startChar": 75,
        "endLine": 366,
        "endChar": 82
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d315e923_4d968865",
        "filename": "init/first_stage_mount.cpp",
        "patchSetId": 7
      },
      "lineNbr": 366,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-08-13T13:13:35Z",
      "side": 1,
      "message": "After more thoughts, I agree with your idea.\nYup, as long as ro.build.system_root_image will still be set for kernel mounts system.img as rootfs, everything works fine.\n\nThe last link probably no need to change, because it\u0027s in \"mount_all\".\nAs /system is always in first-stage-mount, there shouldn\u0027t be another /system in mount_all.\n\n\nFor non-system-as-root in recovery, it still can mount.\nBut the layout becomes /mnt/system/system/etc/, /mnt/system/system/bin, etc.\nWhich is the same layout as ensure_path_mounted_at(\"/\", \"/mnt/system\");\nSo it should have no problem, adding tbao@ to confirm.",
      "parentUuid": "bade4fd9_ffc6e271",
      "range": {
        "startLine": 366,
        "startChar": 75,
        "endLine": 366,
        "endChar": 82
      },
      "revId": "13b51175e9db5a5e8b458133386554e69e0426c2",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    }
  ]
}