#!/usr/bin/bash

set -e

# DEFS='-D_DEFAULT_SOURCE'
DEFS='-D_GNU_SOURCE'
DEFS="$DEFS -DLWT_PTR_BITS=64"

CFLAGS='-fomit-frame-pointer -pthread -Werror -Wall'
CFLAGS="$CFLAGS -fdiagnostics-color=never"

CMD=$(basename $0)

usage()
{
	echo "usage: $CMD [x64 | arm64]" 1>&2
	exit 1
}

if [ $# -ne 1 ] ; then
	usage
fi

ARCH="$1"

if [ "$ARCH" = x64 ] ; then
	DEFS="$DEFS -DLWT_X64"
	CFLAGS="$CFLAGS -m64"
	CC="gcc-11 -std=c17"
	CXX=g++-11
	CPP=cpp-11
	DUMP=objdump
	NM=nm
elif [ "$ARCH" = arm64 ] ; then
	DEFS="$DEFS -DLWT_ARM64"
	CFLAGS="$CFLAGS -march=armv8.1-a"
	CC="aarch64-linux-gnu-gcc-11 -std=c17"
	CXX=aarch64-linux-gnu-g++-11 
	CPP=aarch64-linux-gnu-cpp-11
	DUMP=aarch64-linux-gnu-objdump 
	NM=aarch64-linux-gnu-nm 
else
	usage
fi

run()
{
	echo "+ $*" 1>&2
	"$@"
}

run $CC $DEFS $CFLAGS lwt_genassym.c -static -o lwt_genassym
run ./lwt_genassym | pr -t -e28 > lwt_asm_gen.h

run $CC $DEFS $CFLAGS -S -O3 lwt_sched.c

run $CC $DEFS $CFLAGS -c -O3 lwt_sched.c

run $DUMP lwt_sched.o -d > lwt_sched.dump-$ARCH

run $CPP $DEFS lwt_arch.S > lwt_arch_gen.s
run $CC $DEFS $CFLAGS -c lwt_arch_gen.s
run $DUMP -d lwt_arch_gen.o > lwt_arch_gen.dump-$ARCH

run $CC -r -o lwt.o lwt_arch_gen.o lwt_sched.o
run $DUMP -d lwt.o > lwt.dump-ARCH

{
	$NM lwt.o | egrep ' [TDB] '
	$NM lwt.o | fgrep ' U '
} | tee lwt-syms-$ARCH

run $CC $DEFS $CFLAGS -c -O3 test.c

BINARIES=''

for PROG in test ; do
	for HW in '-DLWT_MP -DLWT_SMT' -DLWT_MP '' ; do
		hw="${HW/DLWT_/}"
		hw="${hw/DLWT_/}"
		hw="${hw/ /}"
		hw="${hw@L}"
		for BUILD in -DLWT_DEBUG -DLWT_BITS '' ; do
			build="${BUILD/DLWT_/}"
			for COMP_OPT in -g -O3 '-O3 -g' ; do
				comp_opt="${COMP_OPT/ /}"
				BIN="${PROG}${hw}${build}${comp_opt}-${ARCH}"
				BINARIES="$BINARIES ./$BIN"
				run $CC $DEFS $CFLAGS \
					$HW \
					$BUILD \
					$COMP_OPT \
					-o $BIN \
					$PROG.c \
					lwt_sched.c \
					lwt_arch_gen.s
			done
		done
	done
done

echo $BINARIES | tr ' ' '\012' > binaries-$ARCH

run $CC $DEFS $CFLAGS -DLWT_DEBUG -g -o test_schedq-g-$ARCH test_schedq.c lwt_arch_gen.s
run $CC $DEFS $CFLAGS -DLWT_DEBUG -O3 -o test_schedq-O3-$ARCH test_schedq.c lwt_arch_gen.s
run $CC $DEFS $CFLAGS -DLWT_DEBUG -O3 -g -o test_schedq-O3-g-$ARCH test_schedq.c lwt_arch_gen.s

if false ; then
$CC $DEFS $CFLAGS -DLWT_DEBUG -g -o test-g-$ARCH test.c lwt_sched.c lwt_arch_gen.s
$CC $DEFS $CFLAGS -DLWT_DEBUG -O3 -o test-O3-$ARCH test.c lwt_sched.c lwt_arch_gen.s
$CC $DEFS $CFLAGS -DLWT_DEBUG -O3 -g -o test-O3-g-$ARCH test.c lwt_sched.c lwt_arch_gen.s

$CC -DLWT_MP $DEFS $CFLAGS -DLWT_DEBUG -g -o test-mp-g-$ARCH test.c lwt_sched.c lwt_arch_gen.s
$CC -DLWT_MP $DEFS $CFLAGS -DLWT_DEBUG -O3 -o test-mp-O3-$ARCH test.c lwt_sched.c lwt_arch_gen.s
$CC -DLWT_MP $DEFS $CFLAGS -DLWT_DEBUG -O3 -g -o test-mp-O3-g-$ARCH test.c lwt_sched.c lwt_arch_gen.s

$CC -DLWT_MP $DEFS $CFLAGS -DLWT_BITS -g -o test-mp-g-no-LWT_DEBUG-$ARCH test.c lwt_sched.c lwt_arch_gen.s
$CC -DLWT_MP $DEFS $CFLAGS -DLWT_BITS -O3 -o test-mp-O3-no-LWT_DEBUG-$ARCH test.c lwt_sched.c lwt_arch_gen.s
$CC -DLWT_MP $DEFS $CFLAGS -DLWT_BITS -O3 -g -o test-mp-O3-g-no-LWT_DEBUG-$ARCH test.c lwt_sched.c lwt_arch_gen.s
fi

if [ "$ARCH" = x64 ] ; then
	run clang -std=c17 $DEFS $CFLAGS -DLWT_DEBUG -g -o test_schedq-clang-g-$ARCH test_schedq.c lwt_arch_gen.s
fi

# $CXX -std=c++17 $DEFS $CFLAGS -DLWT_DEBUG -g -o test_schedq-c++-g-$ARCH test_schedq.c lwt_arch_gen.s

if [ "$ARCH" = x64 ] ; then
	run $CC $DEFS $CFLAGS -O3 -g -o test-pthread-O3-g-$ARCH test-pthread.c
fi
