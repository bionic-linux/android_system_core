/*
 * Copyright (C) 2022 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <stdbool.h>
#include <stdlib.h>
#include <stdio.h>
#include "lwt.h"

#define	LWT_C

#include "lwt_types.h"
#include "lwt_arch.h"
#include "lwt_sched.h"

#define GEN(type, field, name)						\
        printf("#define " #name "\t0x%08lx\n", offsetof(type, field))

#define GEN_FIELD(type, field)	GEN(type, field, field)
#define GEN_ARRAY(type, field)	GEN(type, field[0], field)

#define GEN_FIELD_SIZEOF(type, field)					\
        printf("#define SIZEOF_" #type "_" #field" \t0x%08lx\n",	\
		SIZEOF_FIELD(type, field))

#define GEN_SIZEOF(type)						\
        printf("#define SIZEOF_" #type "\t0x%08lx	// %ld\n",	\
		sizeof(type), sizeof(type))

#define GEN_CONSTANT(value)						\
        printf("#define " #value "\t0x%08x	// %d\n", value, value)

#define GEN_CONSTANT64(value)						\
        printf("#define " #value "\t0x%016lxuL	// %ld\n", value, value)

int main()
{
	puts("\n// WARNING: do not edit, generated by lwt_genassym.c");

	puts("\n// thrln_t");
	GEN_SIZEOF(thrln_t);
        GEN_FIELD(thrln_t, ln_next);
        GEN_FIELD(thrln_t, ln_prev);

	puts("");
	GEN_CONSTANT(LLLIST_GEN_SHIFT);
	GEN_CONSTANT(LLLIST_GEN_BITS);
	GEN_CONSTANT(LLLIST_COUNT_SHIFT);
	GEN_CONSTANT(LLLIST_COUNT_BITS);

	puts("");
	GEN_CONSTANT(STKCACHE_BUCKETS);

	puts("");
	GEN_CONSTANT64(MTXID_NULL);
	GEN_CONSTANT64(MTXID_DUMMY);

	puts("");
	GEN_CONSTANT64(THRID_NULL);
	GEN_CONSTANT(THRIX_BITS);
	GEN_CONSTANT(THRIX_BITS);
	GEN_CONSTANT64(THRIX_MASK);
	GEN_CONSTANT(THRIX_RESERVED_COUNT);
	GEN_CONSTANT64(THRIX_MAX);
	GEN_CONSTANT64(THRIX_RESERVED_THRLN);
	GEN_CONSTANT64(THRIX_INVALID_1);
	GEN_CONSTANT64(THRIX_INVALID_2);

	puts("");
	GEN_CONSTANT(THRID_INDEX_SHIFT);
	GEN_CONSTANT(THRID_INDEX_BITS);
	GEN_CONSTANT(THRID_REUSE_SHIFT);
	GEN_CONSTANT(THRID_REUSE_BITS);

	puts("");
	GEN_CONSTANT(SCHEDQ_STATE_SHIFT);
	GEN_CONSTANT(SCHEDQ_STATE_BITS);
	GEN_CONSTANT(SCHEDQ_INS_SHIFT);
	GEN_CONSTANT(SCHEDQ_INS_BITS);
	GEN_CONSTANT(SCHEDQ_INSPRV_SHIFT);
	GEN_CONSTANT(SCHEDQ_INSPRV_BITS);
	GEN_CONSTANT(SCHEDQ_REMNXT_SHIFT);
	GEN_CONSTANT(SCHEDQ_REMNXT_BITS);
	GEN_CONSTANT(SCHEDQ_REM_SHIFT);
	GEN_CONSTANT(SCHEDQ_REM_BITS);
	GEN_CONSTANT(SCHEDQ_GEN_BITS);
	GEN_CONSTANT(SCHEDQ_RCNT_SHIFT);
	GEN_CONSTANT(SCHEDQ_RCNT_BITS);
	GEN_CONSTANT(SCHEDQ_RSER_SHIFT);
	GEN_CONSTANT(SCHEDQ_RSER_BITS);
	GEN_CONSTANT(SCHEDQ_ISER_SHIFT);
	GEN_CONSTANT(SCHEDQ_ISER_BITS);
	GEN_CONSTANT(SCHEDQ_ICNT_SHIFT);
	GEN_CONSTANT(SCHEDQ_ICNT_BITS);

	puts("");
	GEN_CONSTANT(SQ_PRIO_MAX);

	puts("");
	GEN_CONSTANT(THRLN_NEXT_BIT0_SHIFT);
	GEN_CONSTANT(THRLN_NEXT_BIT0_BITS);
	GEN_CONSTANT(THRLN_NEXT_TIX_SHIFT);
	GEN_CONSTANT(THRLN_NEXT_TIX_BITS);
	GEN_CONSTANT(THRLN_NEXT_RSER_SHIFT);
	GEN_CONSTANT(THRLN_NEXT_RSER_BITS);
	GEN_CONSTANT(THRLN_NEXT_SQIX_SHIFT);
	GEN_CONSTANT(THRLN_NEXT_SQIX_BITS);
	GEN_CONSTANT(THRLN_NEXT_PAD_SHIFT);
	GEN_CONSTANT(THRLN_NEXT_PAD_BITS);
	GEN_CONSTANT(THRLN_NEXT_HIGH_SHIFT);
	GEN_CONSTANT(THRLN_NEXT_HIGH_BITS);

	puts("");
	GEN_CONSTANT(THRLN_PREV_BIT0_SHIFT);
	GEN_CONSTANT(THRLN_PREV_BIT0_BITS);
	GEN_CONSTANT(THRLN_PREV_TIX_SHIFT);
	GEN_CONSTANT(THRLN_PREV_TIX_BITS);
	GEN_CONSTANT(THRLN_PREV_ISER_SHIFT);
	GEN_CONSTANT(THRLN_PREV_ISER_BITS);
	GEN_CONSTANT(THRLN_PREV_SQIX_SHIFT);
	GEN_CONSTANT(THRLN_PREV_SQIX_BITS);
	GEN_CONSTANT(THRLN_PREV_PAD_SHIFT);
	GEN_CONSTANT(THRLN_PREV_PAD_BITS);
	GEN_CONSTANT(THRLN_PREV_HIGH_SHIFT);
	GEN_CONSTANT(THRLN_PREV_HIGH_BITS);

	puts("");
	GEN_CONSTANT64(THRLN_HIGH_VALUE);

	puts("");
	GEN_CONSTANT(THRA_HOLD_SHIFT);
	GEN_CONSTANT(THRA_HOLD_BITS);
	GEN_CONSTANT(THRA_STATE_SHIFT);
	GEN_CONSTANT(THRA_STATE_BITS);
	GEN_CONSTANT(THRA_CANCEL_SHIFT);
	GEN_CONSTANT(THRA_CANCEL_BITS);
	GEN_CONSTANT(THRA_WAITTIMEDOUT_SHIFT);
	GEN_CONSTANT(THRA_WAITTIMEDOUT_BITS);
	GEN_CONSTANT(THRA_PAD_SHIFT);
	GEN_CONSTANT(THRA_PAD_BITS);
	GEN_CONSTANT(THRA_LLASYNCNEXT_SHIFT);
	GEN_CONSTANT(THRA_LLASYNCNEXT_BITS);
	GEN_CONSTANT(THRA_INDEX_SHIFT);
	GEN_CONSTANT(THRA_INDEX_BITS);
	GEN_CONSTANT(THRA_REUSE_SHIFT);
	GEN_CONSTANT(THRA_REUSE_BITS);

	puts("");
	GEN_CONSTANT(MTX_UNLOCKED);
	GEN_CONSTANT(MTX_LLLIST_EMPTY);

	puts("");
	GEN_CONSTANT(MTXA_LLWANT_SHIFT);
	GEN_CONSTANT(MTXA_LLWANT_BITS);
	GEN_CONSTANT(MTXA_LLASYNC_SHIFT);
	GEN_CONSTANT(MTXA_LLASYNC_BITS);
	GEN_CONSTANT(MTXA_PADLO_BITS);
	GEN_CONSTANT(MTXA_RECCNT_SHIFT);
	GEN_CONSTANT(MTXA_RECCNT_BITS);
	GEN_CONSTANT(MTXA_OWNER_SHIFT);
	GEN_CONSTANT(MTXA_OWNER_BITS);
	GEN_CONSTANT(MTXA_TYPE_SHIFT);
	GEN_CONSTANT(MTXA_TYPE_BITS);
	GEN_CONSTANT(MTXA_PADHI_BITS);
	GEN_CONSTANT(MTXA_REUSE_SHIFT);
	GEN_CONSTANT(MTXA_REUSE_BITS);
	puts("\n// thrattr_t");
	GEN_SIZEOF(thrattr_t);

	puts("\n// thr_t");
	GEN_SIZEOF(thr_t);
	GEN_FIELD(thr_t, thr_ln);
	GEN_FIELD(thr_t, thr_core);
	GEN_FIELD(thr_t, thr_running);

	puts("\n// cpu_t");
	GEN_SIZEOF(cpu_t);
        GEN_FIELD(cpu_t, cpu_running_thr);

#ifndef LWT_CTX_ARRAY //{
	puts("\n// ctx_t");
        GEN_SIZEOF(ctx_t);
        GEN_FIELD(ctx_t, ctx_pc);
        GEN_FIELD(ctx_t, ctx_flags);

#ifdef LWT_ARM64 //{
	GEN_FIELD(ctx_t, ctx_x0);
	GEN_FIELD(ctx_t, ctx_x1);
	GEN_FIELD(ctx_t, ctx_x2);
	GEN_FIELD(ctx_t, ctx_x3);
	GEN_FIELD(ctx_t, ctx_x4);
	GEN_FIELD(ctx_t, ctx_x5);
	GEN_FIELD(ctx_t, ctx_x6);
	GEN_FIELD(ctx_t, ctx_x7);
	GEN_FIELD(ctx_t, ctx_x8);
	GEN_FIELD(ctx_t, ctx_x9);
	GEN_FIELD(ctx_t, ctx_x10);
	GEN_FIELD(ctx_t, ctx_x11);
	GEN_FIELD(ctx_t, ctx_x12);
	GEN_FIELD(ctx_t, ctx_x13);
	GEN_FIELD(ctx_t, ctx_x14);
	GEN_FIELD(ctx_t, ctx_x15);
	GEN_FIELD(ctx_t, ctx_x16);
	GEN_FIELD(ctx_t, ctx_x17);
	GEN_FIELD(ctx_t, ctx_x18);
	GEN_FIELD(ctx_t, ctx_x19);
	GEN_FIELD(ctx_t, ctx_x20);
	GEN_FIELD(ctx_t, ctx_x21);
	GEN_FIELD(ctx_t, ctx_x22);
	GEN_FIELD(ctx_t, ctx_x23);
	GEN_FIELD(ctx_t, ctx_x24);
	GEN_FIELD(ctx_t, ctx_x25);
	GEN_FIELD(ctx_t, ctx_x26);
	GEN_FIELD(ctx_t, ctx_x27);
	GEN_FIELD(ctx_t, ctx_x28);
	GEN_FIELD(ctx_t, ctx_x29);
	GEN_FIELD(ctx_t, ctx_x30);
	GEN_FIELD(ctx_t, ctx_sp);
	GEN_FIELD(ctx_t, ctx_flags);
	GEN_FIELD(ctx_t, ctx_fpctx);
#endif //}

#ifdef LWT_X64 //{
	GEN_FIELD(ctx_t, ctx_sp);
	GEN_FIELD(ctx_t, ctx_rbp);
	GEN_FIELD(ctx_t, ctx_r12);
	GEN_FIELD(ctx_t, ctx_r13);
	GEN_FIELD(ctx_t, ctx_r14);
	GEN_FIELD(ctx_t, ctx_r15);
	GEN_FIELD(ctx_t, ctx_rbx);
	GEN_FIELD(ctx_t, ctx_rax);
	GEN_FIELD(ctx_t, ctx_rcx);
	GEN_FIELD(ctx_t, ctx_rdx);
	GEN_FIELD(ctx_t, ctx_rdi);
	GEN_FIELD(ctx_t, ctx_rsi);
	GEN_FIELD(ctx_t, ctx_r8);
	GEN_FIELD(ctx_t, ctx_r9);
	GEN_FIELD(ctx_t, ctx_r10);
	GEN_FIELD(ctx_t, ctx_r11);
	GEN_FIELD(ctx_t, ctx_flags);
	GEN_FIELD(ctx_t, ctx_fpctx);
#endif //}
#endif //}
}
