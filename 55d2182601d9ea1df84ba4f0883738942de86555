{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "140549be_c3853676",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "Added comments pointing to new code to make code review easy.\n\nHere is how I would read the code:\n\n1: snapuserd_core.cpp - Start() -\u003e Start the merge thread\n2: snapuserd_merge.cpp - Core of the merge logic and should be easy to read.\n3: snapuserd_ra.cpp - Read-Ahead logic - I have put comments on where to focus and interaction with the merge thread.\n4: snapuserd_transitions.cpp - This is core of state transitions.\n",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "85eceb0a_70e8987e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "Doing another pass, I used a diff tool to compare this against the legacy merge code to get an idea for what changed...",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ecb1cc15_8dfde504",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:52:12Z",
      "side": 1,
      "message": "Also, thanks for splitting this up into these pieces. The new organization is a huge improvement versus the legacy one.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "94ef30da_99b0785a",
        "filename": "fs_mgr/libsnapshot/snapuserd/Android.bp",
        "patchSetId": 2
      },
      "lineNbr": 64,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:20:59Z",
      "side": 1,
      "message": "nit: \"userspace\"",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "65cd9be2_04da6cda",
        "filename": "fs_mgr/libsnapshot/snapuserd/Android.bp",
        "patchSetId": 2
      },
      "lineNbr": 67,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "\"readahead\"?",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ef37f60a_d4e62d1d",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 2,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2021-08-31T18:00:34Z",
      "side": 1,
      "message": "2021",
      "range": {
        "startLine": 2,
        "startChar": 17,
        "endLine": 2,
        "endChar": 21
      },
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b501b488_1f34dda9",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 20,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "I have put comments in the code below pointing to the new changes. Rest all are existing code from Android S.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5201df71_64c78e30",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 31,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "We will need to pass the \"Base\" device additionally which will be used for merging.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "b2966907_a34d832e",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 140,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "This is the new change - no more assigning of pseudo chunk-id as compared to dm-snapshot.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ebc5b6ec_0a177852",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 204,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "We will be setting the size of dm-user device based on the size of the \"Base\" device.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a50a3bf5_34879002",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 338,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "Start the merge thread",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f67aafe0_29a2dd2d",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 362,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "needs an initial value since it\u0027s conditionally assigned and unconditionally read",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f862b835_ac3ee695",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.cpp",
        "patchSetId": 2
      },
      "lineNbr": 364,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "move declaration here",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "581b4529_c0025a58",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.h",
        "patchSetId": 2
      },
      "lineNbr": 1,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2021-08-31T18:00:34Z",
      "side": 1,
      "message": "2021",
      "range": {
        "startLine": 1,
        "startChar": 17,
        "endLine": 1,
        "endChar": 21
      },
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "73129e73_cc0dc2db",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.h",
        "patchSetId": 2
      },
      "lineNbr": 64,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:20:59Z",
      "side": 1,
      "message": "Is this identical to the old one? If so, we should split it out. If not, rename to BufferSink?",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33951273_b997126c",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.h",
        "patchSetId": 2
      },
      "lineNbr": 83,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:20:59Z",
      "side": 1,
      "message": "Similarly, XorBufferSink?\n\nI\u0027d also advocate that we remove XOR support from the old snapuserd and only keep it in the new one. No point in porting new features to something we\u0027re trying to obsolete.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "61518863_441d4931",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_core.h",
        "patchSetId": 2
      },
      "lineNbr": 196,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "I think it\u0027s time we give this a new name, since \"snapuserd\" appears in a lot of places in lots of forms. SnapshotThread? SnapshotHandler?",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b390fb32_ba762152",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_dm_user.cpp",
        "patchSetId": 2
      },
      "lineNbr": 2,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2021-08-31T18:00:34Z",
      "side": 1,
      "message": "2021",
      "range": {
        "startLine": 2,
        "startChar": 17,
        "endLine": 2,
        "endChar": 21
      },
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3d273678_6667a762",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_dm_user.cpp",
        "patchSetId": 2
      },
      "lineNbr": 208,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "No new code changes in this file - it is just a copy of the existing code and does only the initialization. No communication to dm-user yet - this will be done in the next patch",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33377d74_e35a6249",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_merge.cpp",
        "patchSetId": 2
      },
      "lineNbr": 2,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2021-08-31T18:00:34Z",
      "side": 1,
      "message": "2021",
      "range": {
        "startLine": 2,
        "startChar": 17,
        "endLine": 2,
        "endChar": 21
      },
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fd585ccf_13b86e53",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_merge.cpp",
        "patchSetId": 2
      },
      "lineNbr": 268,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "This entire file is the core of the merge logic.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "48fc018a_19e2f8de",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_ra.cpp",
        "patchSetId": 2
      },
      "lineNbr": 116,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "No change in this function.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0a31ef44_604c1a29",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_ra.cpp",
        "patchSetId": 2
      },
      "lineNbr": 166,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "What\u0027s the expected logging impact of this, and the logging loop above? Is it a few lines, or potentially tens? Or hundreds?\n\nIf the intent is for post-mortem analysis of failed merges, we might want to consider storing it somewhere else as update_engine does.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "20f0f634_2a15854b",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_ra.cpp",
        "patchSetId": 2
      },
      "lineNbr": 194,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "The logic of this function slightly changes as we now have to interact with the merge thread. The transition is explained in detail under snapuserd_transitions.cpp.\n\nAt a high level, this will read the fixed set of COW ops and wait for the merge thread to begin merging. Comments have been added.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "64f6bc1b_369d0026",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_ra.cpp",
        "patchSetId": 2
      },
      "lineNbr": 212,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "If you want to save on typing for lines like this, you can use \"auto ra_temp_buffer \u003d ...\"",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3c425a30_51784059",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_ra.cpp",
        "patchSetId": 2
      },
      "lineNbr": 259,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "Same for these two lines, \"auto\" would improve readability quite a bit.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "34c55155_39b0bada",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_ra.cpp",
        "patchSetId": 2
      },
      "lineNbr": 271,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2021-08-23T22:50:54Z",
      "side": 1,
      "message": "size_t for \"i\" and \"j\". But on those names... when we have nested loops like this, with multiple iterators, it\u0027d be nice if we can find better ones, and/or use STL iterators where appropriate. Eg \"i\" is a block index, \"j\" is a xor index, and \"k\" is a byte offset. Otherwise it\u0027s very easy to confuse which letters go where.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "be75f5cc_b2101a21",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_ra.cpp",
        "patchSetId": 2
      },
      "lineNbr": 377,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "No new changes in rest of the functions..",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3702e27b_5d880310",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_transitions.cpp",
        "patchSetId": 2
      },
      "lineNbr": 2,
      "author": {
        "id": 1710792
      },
      "writtenOn": "2021-08-31T18:00:34Z",
      "side": 1,
      "message": "2021",
      "range": {
        "startLine": 2,
        "startChar": 17,
        "endLine": 2,
        "endChar": 21
      },
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9899a257_c69362a1",
        "filename": "fs_mgr/libsnapshot/snapuserd/user-space-merge/snapuserd_transitions.cpp",
        "patchSetId": 2
      },
      "lineNbr": 20,
      "author": {
        "id": 1724998
      },
      "writtenOn": "2021-08-18T17:23:04Z",
      "side": 1,
      "message": "This is the state transition between merge thread and RA thread. Comments have been added in detail to explain the flow.",
      "revId": "55d2182601d9ea1df84ba4f0883738942de86555",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}