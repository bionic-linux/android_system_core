{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "a9ec1791_f8951493",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2022-10-17T19:31:49Z",
      "side": 1,
      "message": "Can you clarify the bug here and how it relates to b/213617178? We spent a lot of time auditing this code last year. It\u0027s quite complex but we came to the conclusion it\u0027s safe. In particular signalfd claims to compress multiple SIGCHILDs so it\u0027s necessary to reap all outstanding children.\n\nWe did want to simplify this code and replace it with pidfd this year, but I think that\u0027s unlikely to happen right now.",
      "revId": "31997af63cbfb8eba1fa960a8896ac4c3e82e643",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0d2c081a_7e9875b3",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2022-10-17T20:10:30Z",
      "side": 1,
      "message": "+1. I saw this CL when looking at the epoll CLs. We\u0027ve experimented with this in the past and it always resulted in missing processes to reap. As David said, we couldn\u0027t reliable get either signalfd or the original signal handlers to consistently trigger per-process.",
      "parentUuid": "a9ec1791_f8951493",
      "revId": "31997af63cbfb8eba1fa960a8896ac4c3e82e643",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9ffdc4c3_44f047c7",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1869780
      },
      "writtenOn": "2022-10-19T14:17:02Z",
      "side": 1,
      "message": "Regarding the question of how this CL is related to b/213617178: the presubmit run for https://android-review.googlesource.com/c/platform/system/core/+/2218645 on September 27 reported a large boot time regression. This CL makes that boot time regression disappear.\n\nRegarding reaping all child processes that exited: isn\u0027t that already guaranteed by calling ReapAnyOutstandingChildren() after epoll_wait() returned?\n\nTom, no Unix kernel guarantees that one SIGCHLD handler call happens per child process that exited. Unix kernels use a single bit to track the \"pending\" state of signals like SIGCHLD (see also the POSIX specification - https://pubs.opengroup.org/onlinepubs/9699919799/functions/V2_chap02.html#tag_15_04). It can happen that multiple child processes exit after SIGCHLD became pending and before the SIGCHLD signal handler is activated.\n\nIs more information available about reliability issues that have been encountered in the past with signalfd?",
      "parentUuid": "0d2c081a_7e9875b3",
      "revId": "31997af63cbfb8eba1fa960a8896ac4c3e82e643",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bd342071_64f3c2e8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 10,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2022-10-20T04:34:38Z",
      "side": 1,
      "message": "\u003e ...on September 27 reported a large boot time regression. This CL makes that boot time regression disappear.\n\nDoes that regression reproduce or do you have more details on why this CL fixes the regression? I don\u0027t see anything in those CLs that would cause a boot time regression that this CL would fix.\n\n\u003e Regarding reaping all child processes that exited: isn\u0027t that already guaranteed by calling ReapAnyOutstandingChildren() after epoll_wait() returned?\n\nThat sounds right though it\u0027s been a while since I\u0027ve looked at this code. What is the motivation behind this CL if we\u0027ll eventually call ReapAnyOutstandingChildren() to read other child processes? I don\u0027t understand why it\u0027s wrong to disregard the SIGCHLD information.\n\n\u003e Tom, no Unix kernel guarantees that one SIGCHLD handler call happens per child process that exited. Unix kernels use a single bit to track the \"pending\" state of signals like SIGCHLD (see also the POSIX specification -\n\nRight, maybe we only tried with the signalfd.\n\n\u003e Is more information available about reliability issues that have been encountered in the past with signalfd?\n\nI don\u0027t have any off-hand. Maybe in old CLs or bugs of mine there\u0027s more information, though the code has changed a lot since then so it likely isn\u0027t worth finding. The summary is we tried removing calls to `ReapAnyOutstandingChildren()` and strictly relying on the SIGCHLD information from the signal FD and then init failed to reap all children. We didn\u0027t see a reason to investigation significantly further since this isn\u0027t code that needs to be highly performance and is code that needs to be highly stable, so marginal extra overhead to call ReapAnyOutstandingChildren() was decided to be worth it.",
      "parentUuid": "9ffdc4c3_44f047c7",
      "revId": "31997af63cbfb8eba1fa960a8896ac4c3e82e643",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}