{
  "comments": [
    {
      "key": {
        "uuid": "ca202730_b94d7fc5",
        "filename": "metricsd/metrics_collector.cc",
        "patchSetId": 3
      },
      "lineNbr": 132,
      "author": {
        "id": 1076863
      },
      "writtenOn": "2016-01-05T16:12:09Z",
      "side": 1,
      "message": "I don\u0027t think this is right. BnMetricsCollectorService is a ref-counted object and should be used inside android::sp\u003c\u003e. Creating it on the stack like that could mean that nasty things could happen (e.g. binder releases the last reference to it and try to call delete on the pointer, but this object is allocated on the stack and not on the heap).",
      "range": {
        "startLine": 132,
        "startChar": 2,
        "endLine": 132,
        "endChar": 31
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aa3e9347_e0ad82c3",
        "filename": "metricsd/metrics_collector.cc",
        "patchSetId": 3
      },
      "lineNbr": 132,
      "author": {
        "id": 1004277
      },
      "writtenOn": "2016-01-05T19:37:56Z",
      "side": 1,
      "message": "OK, thanks.  It looks like other code in metricsd_main.cc needs an update as well, will also send a patch for that after this is settled.",
      "parentUuid": "ca202730_b94d7fc5",
      "range": {
        "startLine": 132,
        "startChar": 2,
        "endLine": 132,
        "endChar": 31
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2a52a3ad_3f55c3a0",
        "filename": "metricsd/metrics_collector.cc",
        "patchSetId": 3
      },
      "lineNbr": 132,
      "author": {
        "id": 1004277
      },
      "writtenOn": "2016-01-05T22:14:22Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "aa3e9347_e0ad82c3",
      "range": {
        "startLine": 132,
        "startChar": 2,
        "endLine": 132,
        "endChar": 31
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8a1aaf01_37e418f6",
        "filename": "metricsd/metrics_collector_service_impl.cc",
        "patchSetId": 3
      },
      "lineNbr": 30,
      "author": {
        "id": 1076863
      },
      "writtenOn": "2016-01-05T16:12:09Z",
      "side": 1,
      "message": "This should be initialized in constructor\u0027s initializer list.",
      "range": {
        "startLine": 30,
        "startChar": 2,
        "endLine": 30,
        "endChar": 40
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ca202730_bcf80d6b",
        "filename": "metricsd/metrics_collector_service_impl.cc",
        "patchSetId": 3
      },
      "lineNbr": 30,
      "author": {
        "id": 1004277
      },
      "writtenOn": "2016-01-05T22:14:22Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "8a1aaf01_37e418f6",
      "range": {
        "startLine": 30,
        "startChar": 2,
        "endLine": 30,
        "endChar": 40
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8a1aaf01_d70fdc7d",
        "filename": "metricsd/metrics_collector_service_impl.cc",
        "patchSetId": 3
      },
      "lineNbr": 38,
      "author": {
        "id": 1076863
      },
      "writtenOn": "2016-01-05T16:12:09Z",
      "side": 1,
      "message": "I think this whole method could be moved to daemon\u0027s Init() method. There is no need to abstract the binder anymore. This will make the code even simpler (I think).",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 38,
        "endChar": 68
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "8a1aaf01_9a42e923",
        "filename": "metricsd/metrics_collector_service_impl.cc",
        "patchSetId": 3
      },
      "lineNbr": 38,
      "author": {
        "id": 1004277
      },
      "writtenOn": "2016-01-05T22:14:22Z",
      "side": 1,
      "message": "I moved the binder watcher stuff to metrics_collector main, which yeah is truly global.  I left the service registration here in a Publish() method of the Impl class, for which there\u0027s existing precedent and it does seem a reasonable thing to encapsulate in the class, but still open to suggestion on this.",
      "parentUuid": "8a1aaf01_d70fdc7d",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 38,
        "endChar": 68
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aa1773d7_9e097d7b",
        "filename": "metricsd/metrics_collector_service_impl.cc",
        "patchSetId": 3
      },
      "lineNbr": 38,
      "author": {
        "id": 1076863
      },
      "writtenOn": "2016-01-05T22:25:57Z",
      "side": 1,
      "message": "On a second look, the remaining code is also wrong. IServiceManager::addService() takes sp\u003cIBinder\u003e and not a raw binder pointer. What happens here is a new strong pointer is created for raw |this| pointer (and this pointer has a ref count of 0). Even though BnMetricsCollectorServiceImpl might be owned by another ref-counted strong pointer elsewhere, the ref count of sp\u003c\u003e passed to the service manager will not respect a global ref count. So, as soon as service manager releases the pointer, the object will be deleted, even though there might be other parties holding on to it.\n\nOne more reason to remove publishing out of the instance of the class and delegate this to the daemon who is holding the original sp\u003c\u003e in the first place....",
      "parentUuid": "8a1aaf01_9a42e923",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 38,
        "endChar": 68
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ea1debf7_c3c07c55",
        "filename": "metricsd/metrics_collector_service_impl.cc",
        "patchSetId": 3
      },
      "lineNbr": 38,
      "author": {
        "id": 1004277
      },
      "writtenOn": "2016-01-05T23:08:25Z",
      "side": 1,
      "message": "Done.  Could pass the sp\u003cBnMetricsCollectorServiceImpl\u003e as an argument to Publish(), but since there\u0027s a strong preference for moving it to the main will do that, thanks.\n\nThere\u0027s at least one other place in Android that needs fixing for this, will put that on the list.  Although I\u0027m beginning to feel my dabbling in C++ userspace is not such a good idea :P",
      "parentUuid": "aa1773d7_9e097d7b",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 38,
        "endChar": 68
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aa1773d7_dec375b1",
        "filename": "metricsd/metrics_collector_service_impl.cc",
        "patchSetId": 3
      },
      "lineNbr": 38,
      "author": {
        "id": 1076863
      },
      "writtenOn": "2016-01-05T23:27:18Z",
      "side": 1,
      "message": "Nah, crazy talk :)",
      "parentUuid": "ea1debf7_c3c07c55",
      "range": {
        "startLine": 34,
        "startChar": 0,
        "endLine": 38,
        "endChar": 68
      },
      "revId": "e1c8290357644d031b3dfc2c59cf67aacbd956c1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}