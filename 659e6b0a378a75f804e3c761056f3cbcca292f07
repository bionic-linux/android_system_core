{
  "comments": [
    {
      "key": {
        "uuid": "d05b1e19_60c790e6",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 257,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-16T03:23:35Z",
      "side": 1,
      "message": "Those dm-verity parameters are generated at build time, and they won\u0027t be changed after dm-linear. That\u0027s my only concern now.",
      "range": {
        "startLine": 255,
        "startChar": 25,
        "endLine": 257,
        "endChar": 45
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "36c8e3c7_4167380e",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 261,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-16T03:23:35Z",
      "side": 1,
      "message": "Same as above.\n\nThe blk_device here is after dm-lnear, assuming it\u0027s /dev/block/dm-1.\nThis might lead to incorrect hash tree data location because hashtree_desc.tree_offset is generated at build time based on \"image size\".\n\nThe dm-verity params is likely:\n1 /dev/block/dm-1 /dev/block/dm-1 4096 4096 125961 125961 sha1 d56fe352cd3e27767d169131e0c551504349b11e cbf37c3a2486698e668a4b6c1d73a985f016358f 10 use_fec_from_device /dev/block/dm-1 fec_roots 2 fec_blocks 126955 fec_start 126955 restart_on_corruption ignore_zero_blocks",
      "range": {
        "startLine": 261,
        "startChar": 83,
        "endLine": 261,
        "endChar": 93
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f8dd1213_2b6dc953",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 324,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-16T03:23:35Z",
      "side": 1,
      "message": "We can check the log here.",
      "range": {
        "startLine": 324,
        "startChar": 4,
        "endLine": 324,
        "endChar": 62
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "906e5e0f_d31d4ffb",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 590,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-14T10:59:08Z",
      "side": 1,
      "message": "The partition_name becomes \"/dev/block/dm-\u003cN\u003e\" (after dm-linear), correct?\n\nNote that this will break AVB because it bakes \u0027partition_name\u0027 into the metadata.\n\n$ avbtool info_image --image $OUT/vbmeta.img \n Hashtree descriptor:\n      Version of dm-verity:  1\n      Image Size:            515936256 bytes\n      Tree Offset:           515936256\n      Tree Size:             4071424 bytes\n      Data Block Size:       4096 bytes\n      Hash Block Size:       4096 bytes\n      FEC num roots:         2\n      FEC offset:            520007680\n      FEC size:              4112384 bytes\n      Hash Algorithm:        sha1\n      Partition Name:        vendor  \u003c--- HERE is the partition name\n      Salt:                  2e9635a4329d4ff96c1d0dc5b26e8880832d30eb\n      Root Digest:           5a9a867aaf21f55b1d41897c7e817bb34cfeb1e0\n      Flags:                 0\n\nhttps://android.googlesource.com/platform/external/avb/+/master/libavb/avb_ops.h#128",
      "range": {
        "startLine": 590,
        "startChar": 8,
        "endLine": 590,
        "endChar": 22
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5a44fd8b_090b5ff2",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 590,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-05-14T15:31:14Z",
      "side": 1,
      "message": "As far as I understand this logical_partition_name will be literally \u0027vendor\u0027 in this case, so it will work.\n\nAs an aside, it would be good to include the example DT snippet / fstab snippet in the commit instead of just in the review comments for posterity.",
      "parentUuid": "906e5e0f_d31d4ffb",
      "range": {
        "startLine": 590,
        "startChar": 8,
        "endLine": 590,
        "endChar": 22
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c2027326_729b0714",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 590,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2018-05-14T19:32:31Z",
      "side": 1,
      "message": "Yes, exactly - logical_partition_name will be what AVB expects. Okay, I\u0027ll include sample fstabs.",
      "parentUuid": "5a44fd8b_090b5ff2",
      "range": {
        "startLine": 590,
        "startChar": 8,
        "endLine": 590,
        "endChar": 22
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "71d9e455_7df12435",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 590,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-16T03:23:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c2027326_729b0714",
      "range": {
        "startLine": 590,
        "startChar": 8,
        "endLine": 590,
        "endChar": 22
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "ac436558_711f7990",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 605,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-14T10:59:08Z",
      "side": 1,
      "message": "get_hashtree_descriptor(\"/dev/block/dm-\u003cN\u003e\") will return false because the \u0027partition_name\u0027 in vbmeta is determined on build time.",
      "range": {
        "startLine": 605,
        "startChar": 9,
        "endLine": 605,
        "endChar": 47
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6d0b28c1_f3983680",
        "filename": "fs_mgr/fs_mgr_avb.cpp",
        "patchSetId": 6
      },
      "lineNbr": 605,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-16T03:23:35Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ac436558_711f7990",
      "range": {
        "startLine": 605,
        "startChar": 9,
        "endLine": 605,
        "endChar": 47
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "985c2d34_701eef2e",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 327,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-14T10:59:08Z",
      "side": 1,
      "message": "This might break vboot 1.0 as well.\nhttps://android.googlesource.com/platform/system/core/+/master/fs_mgr/fs_mgr_verity.cpp#696\n\nIn the above function, it updates \u0027data_dev\u0027 and \u0027hash_dev\u0027 in the dm-verity params to\n\"/dev/block/platform/soc.0/f9824900.sdhci/by-name/vendor_a\".\nhttps://gitlab.com/cryptsetup/cryptsetup/wikis/DMVerity\n\nAs this is done after \"dm-linear\" now, so the data_dev and hash_dev used in DM_TABLE_LOAD will become \"/dev/block/dm-\u003cN\u003e\", right?",
      "range": {
        "startLine": 327,
        "startChar": 17,
        "endLine": 327,
        "endChar": 48
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a9c64398_413b4686",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 327,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2018-05-14T19:32:31Z",
      "side": 1,
      "message": "I tested vboot 2.0, which works - but I didn\u0027t test vboot 1.0. We\u0027re not sure if dm-linear + vboot 1 will be a supported configuration yet.",
      "parentUuid": "985c2d34_701eef2e",
      "range": {
        "startLine": 327,
        "startChar": 17,
        "endLine": 327,
        "endChar": 48
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "805167e1_23cbffd6",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 327,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-15T01:08:55Z",
      "side": 1,
      "message": "OK, I see. So vboot 1.0 + dm-linear might not be supported (SGTM).\n\nFor your test in vboot 2.0, is the dm-linear align with physical partition size?\ni.e., the logical \u0027vendor\u0027 is actually the same as \"/dev/block/platform/soc.0/f9824900.sdhci/by-name/vendor_a\". Or have you tried the configuration that logical \u0027vendor\u0027 consists of \"/dev/block/platform/soc.0/f9824900.sdhci/by-name/vendor_a\" + part of \"/dev/block/platform/soc.0/f9824900.sdhci/by-name/system_a\", for example.",
      "parentUuid": "a9c64398_413b4686",
      "range": {
        "startLine": 327,
        "startChar": 17,
        "endLine": 327,
        "endChar": 48
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "67ae296c_881d5e40",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 327,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2018-05-15T18:32:15Z",
      "side": 1,
      "message": "For my initial test, it did align with the partition size. But it doesn\u0027t have to: I just added a 512-sector extent from system_a as you suggested, and:\n\nlrwxrwxrwx 1 root root 16 1970-07-29 22:44 vendor_a -\u003e /dev/block/sda20\n\nwalleye:/ # cat /sys/block/dm-1/dm/name                                                                                                                                                       \nvendor_a\nwalleye:/ # cat /sys/block/dm-1/size                                                                                                                                                          \n1024512\nwalleye:/ # cat /sys/block/sda/sda20/size                                                                                                                                                     \n1024000\n\nThe new device is 512 sectors larger as expected.",
      "parentUuid": "805167e1_23cbffd6",
      "range": {
        "startLine": 327,
        "startChar": 17,
        "endLine": 327,
        "endChar": 48
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "87494f3a_31ce99eb",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 327,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-16T03:23:35Z",
      "side": 1,
      "message": "That\u0027s great, would you mind dumping the statistic of dm-2 (assuming it\u0027s dm-verity)?",
      "parentUuid": "67ae296c_881d5e40",
      "range": {
        "startLine": 327,
        "startChar": 17,
        "endLine": 327,
        "endChar": 48
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "34f06078_00759ec8",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 342,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-15T03:32:18Z",
      "side": 1,
      "message": "Just to be clear, the fstab_rec-\u003eblk_device value changes as below (Take vendor as an example),\n\n  Initial value: vendor\n  fs_mgr_update_logical_partition(fstab_rec): vendor --\u003e /dev/block/dm-1 (assuming dm-0 is used by system-as-root)\n  InitMappedDevice(fstab_rec-\u003eblk_device): /dev/block/dm-1\n  SetUpDmVerity(fstab_rec): /dev/block/dm-1 --\u003e /dev/block/dm-2\n  fs_mgr_do_mount_one(fstab_rec): This still mounts /dev/block/dm-2 (and seems dm-1 isn\u0027t used?)",
      "range": {
        "startLine": 327,
        "startChar": 0,
        "endLine": 342,
        "endChar": 5
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2e0d564b_547d5199",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 342,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-05-15T18:12:14Z",
      "side": 1,
      "message": "As I understand it, dm-1 isn\u0027t ever mounted, but it is used as the input block device for the verity device (dm-2).  So there are two layers of virtual block devices (dm-verity -\u003e dm-linear -\u003e physical block device(s)).",
      "parentUuid": "34f06078_00759ec8",
      "range": {
        "startLine": 327,
        "startChar": 0,
        "endLine": 342,
        "endChar": 5
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "be5f22f9_dea7f541",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 342,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2018-05-15T18:32:15Z",
      "side": 1,
      "message": "Right, indeed. /dev/block/dm-1 is used by the mapping for /dev/block/dm-2 and in fact device-mapper won\u0027t let you remove it until dm-2 is removed.",
      "parentUuid": "2e0d564b_547d5199",
      "range": {
        "startLine": 327,
        "startChar": 0,
        "endLine": 342,
        "endChar": 5
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "85da5d05_0688bd77",
        "filename": "init/init_first_stage.cpp",
        "patchSetId": 6
      },
      "lineNbr": 342,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-16T03:23:35Z",
      "side": 1,
      "message": "Understood, thanks!\n\nBtw, my actual concern is dm-verity params, but I didn\u0027t state it well (sorry!)",
      "parentUuid": "be5f22f9_dea7f541",
      "range": {
        "startLine": 327,
        "startChar": 0,
        "endLine": 342,
        "endChar": 5
      },
      "revId": "659e6b0a378a75f804e3c761056f3cbcca292f07",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}