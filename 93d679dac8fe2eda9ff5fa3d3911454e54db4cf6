{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "848fa2d0_4b958366",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-02-20T00:57:42Z",
      "side": 1,
      "message": "Could you please explain why this is safe?",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "85691c19_6369faeb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1869780
      },
      "writtenOn": "2023-02-23T21:29:32Z",
      "side": 1,
      "message": "DebugRebootLogging() can only be called concurrently with CheckShutdown() if sys.powerctl is written twice. My understanding is that sys.powerctl is only written once during a reboot. The sequence is as follows:\n* /system/bin/reboot ... is executed.\n* The sys.powerctl property is set. See also https://source.corp.google.com/android-internal/system/core/reboot/reboot.c \n* property_set() is called.\n* __system_property_set() sends a PROP_MSG_SETPROP2 message.\n* /system/bin/reboot executes the following code:\n\n    // Don\u0027t return early. Give the reboot command time to take effect\n    // to avoid messing up scripts which do \"adb shell reboot \u0026\u0026 adb wait-for-device\"\n    if (cmd \u003d\u003d reboot) {\n        while (1) {\n            pause();\n        }\n    }\n\n* The init process received PROP_MSG_SETPROP2 (handle_property_set_fd()).\n* HandlePropertySet() is called.\n* DebugRebootLogging() is called.\n* PropertySet() is called.\n* NotifyPropertyChange() is called.\n* PropertyChanged() is called.\n* For name \u003d\u003d sys.powerctl, trigger_shutdown() is called.\n* ShutdownState::TriggerShutdown(value) is called.\n* shutdown_command_ and do_shutdown_ are set.\n* WakeMainInitThread() is called.\n* if property_triggers_enabled is true:\n* ActionManager::QueuePropertyChange(name, value) is called.\n* WakeMainInitThread() is called.\n* The main loop is woken up and CheckShutdown() is called.",
      "parentUuid": "848fa2d0_4b958366",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a1ba4c56_75301d2d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-02-24T02:22:44Z",
      "side": 1,
      "message": "\u003e DebugRebootLogging() can only be called concurrently with CheckShutdown() if sys.powerctl is written twice. My understanding is that sys.powerctl is only written once during a reboot. \n\nThanks for the detailed explanation, Bart. I understand that we don\u0027t currently have such a case, but isn\u0027t the check [1] to assert that, so that if someone mistakenly breaks the assumption in the future we get an error?\n\nLet me invite Tom Cherry who wrote the code as I don\u0027t fully understand this part of init. Tom, please review this.\n\n[1] https://cs.android.com/android/platform/superproject/+/master:system/core/init/init.cpp;drc\u003d68a59e1c720871277b01131edb3b64908ad03cbf;l\u003d282",
      "parentUuid": "85691c19_6369faeb",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a35506dc_a8ea0a92",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2023-02-24T05:20:55Z",
      "side": 1,
      "message": "IIRC, `set_do_shutdown` wasn\u0027t added for safety, but rather to have clearer message in the logs for debugging b/150863651, so this is fine. If no one is using `DebugRebootLogging()`, which I suspect is the case, I\u0027d even recommend reverting all of the changes related to `DebugRebootLogging()` as it\u0027s essentially dead code.",
      "parentUuid": "a1ba4c56_75301d2d",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d193482b_5ec48acb",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-02-24T05:22:19Z",
      "side": 1,
      "message": "Thanks for the answer, Tom!",
      "parentUuid": "a35506dc_a8ea0a92",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "726f653e_1e84c66f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1869780
      },
      "writtenOn": "2023-02-24T23:53:31Z",
      "side": 1,
      "message": "I think that `DebugRebootLogging()` is used. I was trying to explain that `DebugRebootLogging()` is not called concurrently with the code modified by this CL.",
      "parentUuid": "d193482b_5ec48acb",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "39c471a0_906d76b7",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-02-26T06:50:53Z",
      "side": 1,
      "message": "Tom, are you saying that this function was just to understand b/150863651 and the real cause of the issue was fixed in somewhere else? Then, yes, I think it\u0027s better to kill this function. (Bart, you may do that in a follow-up change)",
      "parentUuid": "726f653e_1e84c66f",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "70e83254_23ce1e7b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2023-02-27T17:38:35Z",
      "side": 1,
      "message": "Yes that\u0027s what I\u0027m saying. The question is directed to you and dvander@ as the OWNERS of init. If you don\u0027t use that function anymore, then it\u0027s likely worth killing and would make the shutdown code cleaner. \n\nIn either case, this change seems fine.",
      "parentUuid": "39c471a0_906d76b7",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "33515659_7fbba3bf",
        "filename": "/COMMIT_MSG",
        "patchSetId": 2
      },
      "lineNbr": 13,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2023-02-28T02:22:50Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "70e83254_23ce1e7b",
      "range": {
        "startLine": 10,
        "startChar": 62,
        "endLine": 13,
        "endChar": 33
      },
      "revId": "93d679dac8fe2eda9ff5fa3d3911454e54db4cf6",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}