{
  "comments": [
    {
      "key": {
        "uuid": "eb2f888a_6e00efe5",
        "filename": "liblog/logd_write.c",
        "patchSetId": 4
      },
      "lineNbr": 38,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2015-02-13T04:10:58Z",
      "side": 1,
      "message": "please don\u0027t use this in new code. use \u003cstdatomic.h\u003e for C or \u003catomic\u003e for C++.",
      "revId": "01721f3f4843fcae014ea4bd0bf8a6da2f920cd1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "2b9440fe_fdf04798",
        "filename": "liblog/logd_write.c",
        "patchSetId": 4
      },
      "lineNbr": 38,
      "author": {
        "id": 1032276
      },
      "writtenOn": "2015-02-13T15:11:55Z",
      "side": 1,
      "message": "_that_ was the comment I was looking for. I had a voice in my head that said \u0027do not use android atomic\u0027, but when I polled the group I was met with shrugs. Thanks!",
      "parentUuid": "eb2f888a_6e00efe5",
      "revId": "01721f3f4843fcae014ea4bd0bf8a6da2f920cd1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "0b4cdc89_47de301e",
        "filename": "liblog/logd_write.c",
        "patchSetId": 4
      },
      "lineNbr": 38,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2015-02-13T16:47:17Z",
      "side": 1,
      "message": "for next time, we did add a comment to the cutils include file:\n\n/*\n * A handful of basic atomic operations.\n * THESE ARE HERE FOR LEGACY REASONS ONLY.  AVOID.\n *\n * PREFERRED ALTERNATIVES:\n * - Use C++/C/pthread locks/mutexes whenever there is not a\n *   convincing reason to do otherwise.  Note that very clever and\n *   complicated, but correct, lock-free code is often slower than\n *   using locks, especially where nontrivial data structures\n *   are involved.\n * - C11 stdatomic.h.\n * - Where supported, C++11 std::atomic\u003cT\u003e .\n *\n * PLEASE STOP READING HERE UNLESS YOU ARE TRYING TO UNDERSTAND\n * OR UPDATE OLD CODE.\n\nsadly we didn\u0027t have the balls to add #warning. even ignoring vendor code, there\u0027s a *lot* of code using this and its [also] evil libutils twin: https://cs.corp.google.com/#search/\u0026q\u003dinclude.*utils/atomic.h%20-file:vendor/%20-file:device/\u0026sq\u003dpackage:%5Eandroid$\u0026type\u003dcs\u0026m\u003d100\u0026sort\u003d1",
      "parentUuid": "2b9440fe_fdf04798",
      "revId": "01721f3f4843fcae014ea4bd0bf8a6da2f920cd1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "6b5d5831_6a9fb7d2",
        "filename": "liblog/logd_write.c",
        "patchSetId": 4
      },
      "lineNbr": 38,
      "author": {
        "id": 1032276
      },
      "writtenOn": "2015-02-13T17:16:13Z",
      "side": 1,
      "message": "Agreed, sem_wait and sem_post are only a handful of ns when there is no contention; roughly the same as the atomic (C11) operations (as they are, themselves, atomic operations, when there is no contention). Atomics by themselves only make sense for a single counter like we have here.\n\nTL;DR\n\nThe 20us sem_post overhead in the producing thread, or when contention occurs, when it has to tell Linux to wakeup the associated thread(s) is _killing_ me. Regardless, futex as used underneath is still the fastest way to deal with inter-thread locking; I just wish there was a way to tell it to wake up the associated thread(s) lazy by instead inside the kernel posting the wakes into a workqueue quickly and hence return to the producing caller quicker. That 20us of overhead is a result of searching immediately for the key, and twiddling the scheduler for the associated thread(s) which takes time in the context of the caller. I just wish there was some magic bullet, especially in situations where wakeup is normal (as compared to occasionally contended). POSIX offers no means to specify a semaphore attribute as lazy or not, and futex offers no means to specify lazy or not; so not today for sure ...",
      "parentUuid": "0b4cdc89_47de301e",
      "revId": "01721f3f4843fcae014ea4bd0bf8a6da2f920cd1",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    }
  ]
}