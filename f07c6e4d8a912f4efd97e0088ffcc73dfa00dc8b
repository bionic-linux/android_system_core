{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "ca6ada9e_f7ec4a26",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1337669
      },
      "writtenOn": "2022-10-31T07:48:15Z",
      "side": 1,
      "message": "QQ:\n\n1. How large is your /cache dir? How little space is left on your super?\n2. Echoing what David said, why isn\u0027t /data used as scratch storage? Is it that your device have unreliable pinning or is there any other error when using /data as backing storage?",
      "revId": "f07c6e4d8a912f4efd97e0088ffcc73dfa00dc8b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "33a91ca7_90e1137a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1972780
      },
      "writtenOn": "2022-10-31T19:08:37Z",
      "side": 1,
      "message": "Thanks a lot for your review!\n\n1. Let\u0027s consider partition map with 2GB super, 1.5GB cache. If factory image, for example, 1.7GB there will be only 300MB physical space left for logical partition served as a backing storage, while cache has 1.5GB.\n\n2. Please check my answer for David\u0027s comment\n\nWhile answering your questions, I realize that non-A/B device may be configured to store OTA package in the /data dir, while having small /cache. @dvander@google.com @yochiang@google.com If you agree with the general idea I am talking about, what do you think if I do ```if (!IsABDevice() \u0026\u0026 GetBoolProperty(kPreferCacheBackingStorageProp, false))``` in this patchset?",
      "parentUuid": "ca6ada9e_f7ec4a26",
      "revId": "f07c6e4d8a912f4efd97e0088ffcc73dfa00dc8b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf855db1_f8dbce7f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2022-11-01T05:41:20Z",
      "side": 1,
      "message": "It still needs to check VSR level \u003c `__ANDROID_API_T__`. The non-AB code will be removed once it leaves vendor freeze, and with it, code related to /cache.\n\nIf you want to avoid overlayfs entirely for remounts, you can do so in development by disabling `BOARD_EXT4_SHARE_DUP_BLOCKS`, and specifying hardcoded partition sizes to give some wiggle room.",
      "parentUuid": "33a91ca7_90e1137a",
      "revId": "f07c6e4d8a912f4efd97e0088ffcc73dfa00dc8b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9dded378_cf4f7e77",
        "filename": "fs_mgr/fs_mgr_overlayfs.cpp",
        "patchSetId": 2
      },
      "lineNbr": 117,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2022-10-28T17:43:34Z",
      "side": 1,
      "message": "non-AB is no longer supported. In addition, remount should be going through the /data path rather than /cache. If this is an older device that doesn\u0027t have reliable pinning, please change the condition to:\n\n    if (!IsABDevice() \u0026\u0026 GetIntProperty(\"ro.vendor.api_level\") \u003c __ANDROID_API_T__)",
      "revId": "f07c6e4d8a912f4efd97e0088ffcc73dfa00dc8b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2e3da76f_98f52c6f",
        "filename": "fs_mgr/fs_mgr_overlayfs.cpp",
        "patchSetId": 2
      },
      "lineNbr": 117,
      "author": {
        "id": 1972780
      },
      "writtenOn": "2022-10-31T19:08:37Z",
      "side": 1,
      "message": "Thanks a lot for your review!\n\n\u003e non-AB is no longer supported\n\nDo you mean that non-A/B configuration is deprecated? I know that it is considered legacy, but still legal to use. As far as I can see, device/amlogic/yukawa reference target is non-A/B\n\n\u003e remount should be going through the /data path rather than /cache\n\nYou are right, but there are 2 concerns about data that I see:\n\n1. as you mentioned, it might have no reliable pinning in f2fs configuration, and api_level check might not help when the code runs on old enough kernel.\n\n2. /data may be actively used by applications leaving not much space for backing storage.\n\nMeanwhile, /cache is almost always free since it is used only to store OTA package. /cache partition size should be large enough to hold OTA package, that contains update up to the whole super size. So /cache is almost always large enough to be overlay for the most of super\u0027s data.",
      "parentUuid": "9dded378_cf4f7e77",
      "revId": "f07c6e4d8a912f4efd97e0088ffcc73dfa00dc8b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4d9dc59e_f5061567",
        "filename": "fs_mgr/fs_mgr_overlayfs.cpp",
        "patchSetId": 2
      },
      "lineNbr": 117,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2022-11-01T05:41:20Z",
      "side": 1,
      "message": "non-AB will fail VTS for Android 13+ launches (and soon, other xTS as well).\n\nDoes this device have a very small /data partition? Remount is only for development, and developers have control over how much space is free on /data, unless /data has been provisioned very small (say, \u003c4gb).",
      "parentUuid": "2e3da76f_98f52c6f",
      "revId": "f07c6e4d8a912f4efd97e0088ffcc73dfa00dc8b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "eb3abea2_753b0585",
        "filename": "fs_mgr/fs_mgr_overlayfs.cpp",
        "patchSetId": 2
      },
      "lineNbr": 117,
      "author": {
        "id": 1972780
      },
      "writtenOn": "2022-11-01T11:49:40Z",
      "side": 1,
      "message": "\u003e Does this device have a very small /data partition\n\nSome of our devices have 8GB flash for now, but it may be even smaller in future.\n\nConsidering above partition map on 8GB flash with 2GB super and 1.5GB cache, along with our others vendor-specific partitions there may be over 2-2.5GB left for /data. Just after the factory image burned this space is enough, however after some time applications may fill much of the /data leaving very small space for overlay.\n\nAt the same time, /cache is always empty despite of applications usage of /data, so it is preferable to use it.\n\n\u003e Remount is only for development\n\nYou are right, but development process also includes troubleshooting and debugging different cases on userdebug builds from QA or beta channel. For example, there may be a scenario (at least for us it happens almost everyday :)) when QA gives problematic device to research a problem, you rebuild some component with increased verbosity or possible fix, and don\u0027t have enough space in /data or super backing storage to push the artifacts. The proposed solution with property makes it possible to define it in factory build and always use big and free /cache partition without worrying. :)\n\n\u003e non-AB will fail VTS for Android 13+ launches (and soon, other xTS as well).\n\nOh... but what about reference boards like \u0027yukawa\u0027? Or default emulator build? They are both non-A/B, so they fail VTS tests for now? Could you please share the test that would fail?\n\nBTW, does it mean that non-A/B update support would be removed from releasetools and recovery too?",
      "parentUuid": "4d9dc59e_f5061567",
      "revId": "f07c6e4d8a912f4efd97e0088ffcc73dfa00dc8b",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}