{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "beee157e_be805e4c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2023-01-17T20:42:36Z",
      "side": 1,
      "message": "Can you clarify more about the context here? Which caller of WriteToImageFile is getting interrupted?",
      "revId": "6675c44a75e4e511533cbf6a03dd229c7e079717",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a5b02843_80359a73",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1882080
      },
      "writtenOn": "2023-01-18T07:18:57Z",
      "side": 1,
      "message": "In OTA process, the device is doing super merging, one crash happened.\nDump the metadata partition, we find the data of metadata/gsi/lp_metadata is zero.\nThe func SaveMetadata() in file system/core/fs_mgr/libfiemap/metadata.cpp will call WriteToImageFile().",
      "parentUuid": "beee157e_be805e4c",
      "revId": "6675c44a75e4e511533cbf6a03dd229c7e079717",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cebcd06a_b87754b2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2023-01-18T19:20:45Z",
      "side": 1,
      "message": "Okay, I think SaveMetadata is the correct place to do this then, in libfiemap. We should open() with the same flags WriteToImageFile(path) does, and then call WriteToImageFile(fd), and then call fsync().\n\nLet me know if you want us to write the patch.",
      "parentUuid": "a5b02843_80359a73",
      "revId": "6675c44a75e4e511533cbf6a03dd229c7e079717",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "aef83ef5_d4241b83",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1882080
      },
      "writtenOn": "2023-01-19T09:15:43Z",
      "side": 1,
      "message": "There are two places to call WriteToImageFile.\nOne is SaveMetadata(), another is CreateUpdateSnapshots().\nFrom OTA, I think all need to do write file Synchronously.\nSo I think do open with param O_SYNC in WriteToImageFile() is more reasonable.\nI found this commit https://android-review.googlesource.com/c/platform/system/core/+/2329507\nBut this one will raise build error. So I change it.\nOnce I tried to do fsync() in func SaveMetadata(), after calling WriteToImageFile(fd), it can work also.\nIf you don\u0027t agree above, I may submit another patch.  \nThanks very much.",
      "parentUuid": "cebcd06a_b87754b2",
      "revId": "6675c44a75e4e511533cbf6a03dd229c7e079717",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "aa79c2c3_a742f82d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1290458
      },
      "writtenOn": "2023-01-19T15:28:02Z",
      "side": 1,
      "message": "CreateUpdateSnapshots() should probably just use a whole-system sync()...\n\nThe reason we\u0027d prefer not to sync in WriteToImageFile is that has many callers, and some of those callers don\u0027t care about syncing. For example it is unnecessary and slow for host/build tools.",
      "parentUuid": "aef83ef5_d4241b83",
      "revId": "6675c44a75e4e511533cbf6a03dd229c7e079717",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "21f4a19d_8c8abd0d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1269628
      },
      "writtenOn": "2023-01-29T09:23:18Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "aa79c2c3_a742f82d",
      "revId": "6675c44a75e4e511533cbf6a03dd229c7e079717",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}