{
  "comments": [
    {
      "key": {
        "uuid": "bb693ee6_0d0ffe6a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 7
      },
      "lineNbr": 26,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-02T14:38:54Z",
      "side": 1,
      "message": "b/78613232#comment7",
      "range": {
        "startLine": 26,
        "startChar": 6,
        "endLine": 26,
        "endChar": 37
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "129d8482_356db662",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 294,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-02T14:38:54Z",
      "side": 1,
      "message": "This function is to handle block device, usb device won\u0027t reach here.",
      "range": {
        "startLine": 294,
        "startChar": 40,
        "endLine": 294,
        "endChar": 62
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "b6b0e468_258d7ae1",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 336,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-02T14:38:54Z",
      "side": 1,
      "message": "On taimen, the check is unneeded (i.e., there is neither \u0027pci\u0027 nor \u0027vbd\u0027 devices having uevent.partition.name).\n\nTo be safe, still exclude them and only allow \"platform\" devices.",
      "range": {
        "startLine": 334,
        "startChar": 0,
        "endLine": 336,
        "endChar": 9
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "c5eb1a90_5e7e0a4a",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 392,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-02T14:38:54Z",
      "side": 1,
      "message": "block device goes here.",
      "range": {
        "startLine": 392,
        "startChar": 20,
        "endLine": 392,
        "endChar": 42
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "a34616c8_134a1d7e",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 411,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-02T14:38:54Z",
      "side": 1,
      "message": "USB events are handled here.",
      "range": {
        "startLine": 398,
        "startChar": 0,
        "endLine": 411,
        "endChar": 15
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "fe9c168d_35d94ff1",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 411,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-05-02T16:28:32Z",
      "side": 1,
      "message": "I don\u0027t think that\u0027s necessarily true.  I can check myself, but if I attach a USB harddrive or flash drive, doesn\u0027t it enumerate as a USB device (aka through this code) then enumerate its partitions as child block devices?",
      "parentUuid": "a34616c8_134a1d7e",
      "range": {
        "startLine": 398,
        "startChar": 0,
        "endLine": 411,
        "endChar": 15
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "aefe4ca6_fac0fa44",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 411,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-05-02T20:55:04Z",
      "side": 1,
      "message": "I checked with a USB hard drive and I see by-num symlinks in \n\n/dev/block/platform/soc/6a00000.ssusb/6a00000.dwc3/xhci-hcd.0.auto\n\nI don\u0027t see by-name symlinks there, but I\u0027m guessing that the drive I\u0027m using just isn\u0027t formatted right, since the by-name and by-num symlinks are created in the same function.  We\u0027ll need to find a way to distinguish internal and external storage devices before we add this.\n\nPerhaps we can modify FindPlatformDevice() to fail if it doesn\u0027t find purely platform devices all the way up to the sysfs root?  Similar changes would need to be made for FindPciDevicePrefix(), etc.  We\u0027ll want to drop the check for only making these symlinks for platform devices too, as we\u0027ll want the symlinks for Pci and Vbd devices, as the root device is on those.  I\u0027m not sure about SDCards though; they may enumerate entirely through platform devices...\n\nI wouldn\u0027t want to rely on timing either as it\u0027s possible for the external devices to be plugged in since system boot.",
      "parentUuid": "fe9c168d_35d94ff1",
      "range": {
        "startLine": 398,
        "startChar": 0,
        "endLine": 411,
        "endChar": 15
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "f11ab6ed_b13eff3a",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 411,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-03T01:58:34Z",
      "side": 1,
      "message": "Oh, I see. \nI\u0027m not familiar with Pci/Vbd, seems we also want to add by-name symlink for them. Will investigate.\n\nTiming is probably not an issue, as it eventually will generate uevent for processing, not matter it plugged from the beginning or not.",
      "parentUuid": "aefe4ca6_fac0fa44",
      "range": {
        "startLine": 398,
        "startChar": 0,
        "endLine": 411,
        "endChar": 15
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "609c9eda_fb4d035a",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 411,
      "author": {
        "id": 1064128
      },
      "writtenOn": "2018-05-03T19:41:13Z",
      "side": 1,
      "message": "By timing I meant something like:\n\nCreate these symlinks only up until early mount or something like that, with the hope that external storage would only be added after that point, but I don\u0027t think that\u0027s a safe assumption to make.  We really need a way to differentiate.\n\nAs far as I know, Intel uses Pci for some storage (think PCIe storage for laptops).  Vbd is used for emulators running with host.  Both cases it would be the \u0027boot device\u0027 so we\u0027d need to handle it.",
      "parentUuid": "f11ab6ed_b13eff3a",
      "range": {
        "startLine": 398,
        "startChar": 0,
        "endLine": 411,
        "endChar": 15
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "9ba3dda6_aa15028a",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 411,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-11T10:58:57Z",
      "side": 1,
      "message": "I inserted a USB3 disk on the DUT, the uevent will be generated:\n  \nuevent.path\u003d\u0027/devices/soc/a800000.ssusb/a800000.dwc3/xhci-hcd.0.auto/usb2/2-1/2-1.4/2-1.4:1.0/host4/target4:0:0/4:0:0:0/block/sdi/sdi1\u0027, uevent.subsystem\u003d\u0027block\u0027, uevent.partition_num: 1, uevent.partition_name: \u0027system_c\u0027\n\nResulting in two symlinks generated:\n/dev/block/platform/soc/a800000.ssusb/a800000.dwc3/xhci-hcd.0.auto/by-name/system_c\n/dev/block/by-name/system_c\n  \n  \n  \nI also tried a SD card (on another DUT), the result is similar.\nuevent.path\u003d\u0027/devices/platform/externdevice/mmc_host/mmc1/mmc1:0002/block/mmcblk1/mmcblk1p1\u0027, uevent.subsystem\u003d\u0027block\u0027, uevent.partition_num: 1, uevent.partition_name: \u0027system_d\u0027\n  \n/dev/block/platform/externdevice/by-name/system_d\n/dev/block/by-name/system_d\n  \nCan you elaborate more about \"FindPlatformDevice() to fail if it doesn\u0027t find purely platform devices all the way up to the sysfs root? \"  I can think of a method to detect \"purely platform\" devices.\n  \nps: I used \u0027gparted\u0027 to specifically set partition_name.",
      "parentUuid": "609c9eda_fb4d035a",
      "range": {
        "startLine": 398,
        "startChar": 0,
        "endLine": 411,
        "endChar": 15
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "456e2be2_b1eea943",
        "filename": "init/devices.cpp",
        "patchSetId": 7
      },
      "lineNbr": 411,
      "author": {
        "id": 1080813
      },
      "writtenOn": "2018-05-11T10:59:56Z",
      "side": 1,
      "message": "typo in previous comment:\n\n I CANNOT think of a method to detect \"purely platform\" devices.",
      "parentUuid": "9ba3dda6_aa15028a",
      "range": {
        "startLine": 398,
        "startChar": 0,
        "endLine": 411,
        "endChar": 15
      },
      "revId": "79ed568c8ac26e8c896eb5bf9b1a46804bd202a3",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889",
      "unresolved": true
    }
  ]
}