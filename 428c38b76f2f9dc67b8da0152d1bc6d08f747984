{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "61e7247e_34b6db83",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1071150
      },
      "writtenOn": "2021-03-11T09:48:02Z",
      "side": 1,
      "message": "lgtm, modulo the comment about version_script.",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "0955c9a9_24996d87",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-12T01:00:15Z",
      "side": 1,
      "message": "Anton, Jiyong, Mathew, please let me know if you have any feedback, specifically on the active thread about version script, code location, and module sdk.",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a9e60e1b_c52f7c78",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-12T02:01:37Z",
      "side": 1,
      "message": "(I wonder why you don\u0027t use C++ here. It will make code a lot cleaner)\n\ncode location: looks fine to me\n\nversion script: you are not using it, I don\u0027t think that\u0027s a must here",
      "parentUuid": "0955c9a9_24996d87",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "da802511_3a8b2ba2",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 15,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-11T23:29:49Z",
      "side": 1,
      "message": "nit: license header not required for bp files",
      "range": {
        "startLine": 1,
        "startChar": 0,
        "endLine": 15,
        "endChar": 2
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9bc8b11b_e9dc93f3",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 15,
      "author": {
        "id": 1060959
      },
      "writtenOn": "2021-03-12T11:41:01Z",
      "side": 1,
      "message": "just curious, is this documented somewhere?",
      "parentUuid": "da802511_3a8b2ba2",
      "range": {
        "startLine": 1,
        "startChar": 0,
        "endLine": 15,
        "endChar": 2
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c4f0929a_bdf7e0f2",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 21,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-11T06:29:26Z",
      "side": 1,
      "message": "In aosp/1570701, bootstrap: true was added for libnativehelper_lazy (and false was added to libnativehelper). However, I don\u0027t think it is needed. Orion/Jiyong,is this needed if we\u0027re going to just remove statsd from the bootstrap apexes?",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9c81c6f0_84688135",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 21,
      "author": {
        "id": 1071150
      },
      "writtenOn": "2021-03-11T09:48:02Z",
      "side": 1,
      "message": "This was erring on the side of caution in case it gets used elsewhere, but it\u0027s not necessary.",
      "parentUuid": "c4f0929a_bdf7e0f2",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "dd1946dc_f4caeda2",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 21,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-11T23:29:49Z",
      "side": 1,
      "message": "I don\u0027t think bootstrap:true is needed here. That\u0027s needed only when the library is required by one of the \"VERY\" early processes: init, ueventd, apexd, linkerconfig.",
      "parentUuid": "9c81c6f0_84688135",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "830a46d7_a871bf7d",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 21,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-12T01:00:15Z",
      "side": 1,
      "message": "Ack, thanks. I\u0027ll leave it off then.",
      "parentUuid": "dd1946dc_f4caeda2",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5c7d39a8_7ef5ea3f",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 29,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-11T06:29:26Z",
      "side": 1,
      "message": "aosp/1570701 also added the version_script here. Did that serve a functional purpose?",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fe20f23a_7be82fa6",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 29,
      "author": {
        "id": 1071150
      },
      "writtenOn": "2021-03-11T09:48:02Z",
      "side": 1,
      "message": "libnativehelper already has a .map.txt file for defining it\u0027s exported APIs (apex, NDK). Using the same map.txt as version script means we can check all the same symbols exist in libnativehelper_lazy and libnativehelper at build time.\n\nThe sources for libnativehelper_lazy and libnativehelper are in the same directory which makes this easier. Both go into the ART module sdk (stubs for libnativehelper as the real .so is in the ART Apex). This might make it easier to keep in sync with any future extensions to the API.",
      "parentUuid": "5c7d39a8_7ef5ea3f",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "45cd7a20_c29945a0",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 29,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-12T01:00:15Z",
      "side": 1,
      "message": "So the benefit of using the version script here is that it acts as an additional safety check for making sure the lazy versions provide all of the same APIs?\nMy understanding was that the version script could only be used for libraries that are providing actual APIs, which these libraries technically do not do, since they just wrap the actual APIs.\n\nFor code location, I chose to put it here because advice from modularization folks has been to leave code out of packages/modules/StatsD unless it is shipped as part of the apex, and this library is not. This would make it impossible for libstatssocket and libstatssocket_lazy to share the same parent directory. cc\u0027d anton and mathewi in case they have thoughts on this.\n\nLastly, I still dont have a good understanding of the module sdk. This library isn\u0027t actually a part of the statsd apex, so it doesn\u0027t make sense to me to have it be part of the module sdk.",
      "parentUuid": "fe20f23a_7be82fa6",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d707c13a_ee984a7a",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 29,
      "author": {
        "id": 1060959
      },
      "writtenOn": "2021-03-12T11:41:01Z",
      "side": 1,
      "message": "I\u0027m not sure which thread you are referring to. Jiyong is a better reviewer of how these native apis should be exposed than I am. I can comment on this though:\n\n\u003e leave code out of packages/modules/StatsD unless it is shipped as part of the apex\n\nYes, in principle. I\u0027d perhaps relax that to also include scripts, tools etc relevant to the module, but the starting point should be that platform code and module code is separated into different repos.",
      "parentUuid": "45cd7a20_c29945a0",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "617d2e9a_3132dd42",
        "filename": "libstats/socket_lazy/Android.bp",
        "patchSetId": 6
      },
      "lineNbr": 29,
      "author": {
        "id": 1071150
      },
      "writtenOn": "2021-03-12T12:55:04Z",
      "side": 1,
      "message": "Android uses map.txt files for both version_script and stubs. The syntax is the same, actions for stubs are inferred from comments in the file (e.g. APEX api). version_script itself controls visibility of symbols and adds library versioning. For a symbol to be visible, it has to be present, so applying a common version_script/stub file ensures the interface matches.\n\nI mentioned module sdk because the lazy variants mirror the .so in the APEX. It\u0027s okay for the .so to export more methods, but not fewer. If you had a module SDK it could include the lazy variant and platform would build using that (possibly as a prebuilt). In general I don\u0027t know how far module sdk is defined for other teams, ART has folks specifically focused on build matters (mast@, paulduffin@).",
      "parentUuid": "d707c13a_ee984a7a",
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "af86a9ee_cdbdd056",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1431413
      },
      "writtenOn": "2021-03-11T21:24:03Z",
      "side": 1,
      "message": "is it better to return nullptr?",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8cca4222_48f52a4f",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-12T01:00:15Z",
      "side": 1,
      "message": "I think nullptr is only cpp not c. Please let me know if I\u0027m wrong.",
      "parentUuid": "af86a9ee_cdbdd056",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5009127d_1ae2ac3e",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-12T02:01:37Z",
      "side": 1,
      "message": "This file doesn\u0027t need to be written in C. It can be C++.",
      "parentUuid": "8cca4222_48f52a4f",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4bbbb279_89091810",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-12T02:18:16Z",
      "side": 1,
      "message": "I made this C because libnativehelper_lazy is written in C, but also because one of our dependencies (lmkd) used to be C only. They also boot early and need this lib. They build in cpp now, so I don\u0027t think this is an issue anymore, but I\u0027m not sure if other parts of the OS require C. Do you know? I\u0027m tempted to leave this as C since cpp doesn\u0027t offer a whole lot of benefits here...but also if it\u0027s extremely unlikely/impossible for any clients to be in C I can change it.",
      "parentUuid": "5009127d_1ae2ac3e",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "44d1a9cb_c99b851c",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-12T03:30:16Z",
      "side": 1,
      "message": "External interface of this library should remain C (using extern \"C\"), but implementation can be in C++. It won\u0027t affect the client of this lib. You can statically link to libc++.",
      "parentUuid": "4bbbb279_89091810",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f6221d35_f08ef0ef",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1286922
      },
      "writtenOn": "2021-03-12T03:58:31Z",
      "side": 1,
      "message": "Clients will statically link this library though. Wouldn\u0027t that be an issue if they need to build C and this library relies on cpp? I\u0027m really not sure what the requirements of lmkd were.",
      "parentUuid": "44d1a9cb_c99b851c",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f26075c2_7690fe0b",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-12T04:52:24Z",
      "side": 1,
      "message": "lmkd right now is written in C++ and is using lots of C++ libraries. I am not forcing you to write this library in C++ (I shouldn\u0027t be really concerned about readability of a library that I don\u0027t own), but just wanted to say that using C++ will simplify many parts of this file and there\u0027s nothing preventing you from using C++ here.",
      "parentUuid": "f6221d35_f08ef0ef",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f501d213_609cad0d",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 73,
      "author": {
        "id": 1071150
      },
      "writtenOn": "2021-03-12T12:55:04Z",
      "side": 1,
      "message": "The concerns here may be different from libnativehelper. The code in libnativehelper dropped C++ entirely for size since we have faced scrutiny over being the largest module (dropping bionic from the module was a bigger win :-).\n\nMoving lnh to C was several hundred kb difference, but the lazy code would probably use a much smaller subset of C++ libs.",
      "parentUuid": "f26075c2_7690fe0b",
      "range": {
        "startLine": 73,
        "startChar": 15,
        "endLine": 73,
        "endChar": 19
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4c0aab58_5b1c589c",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 123,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-12T02:01:37Z",
      "side": 1,
      "message": "can be replaced with std::call_once",
      "range": {
        "startLine": 122,
        "startChar": 0,
        "endLine": 123,
        "endChar": 47
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "54aa5033_d190ef03",
        "filename": "libstats/socket_lazy/libstatssocket_lazy.c",
        "patchSetId": 6
      },
      "lineNbr": 130,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-03-12T02:01:37Z",
      "side": 1,
      "message": "reinterpret_cast\u003cdecltype(\u0026##name)\u003e(method)\n\nthen you don\u0027t need to pass method_type",
      "range": {
        "startLine": 130,
        "startChar": 15,
        "endLine": 130,
        "endChar": 36
      },
      "revId": "428c38b76f2f9dc67b8da0152d1bc6d08f747984",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}